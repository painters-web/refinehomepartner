
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0D9488">
    <title>New Leads | Partner Portal</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #0D9488; --p-light: #14B8A6; --bg: #F0FDFA; --text: #134E4A; --white: #FFFFFF; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 100px; }

        .header { 
            position: fixed; top: 0; width: 100%; height: 70px; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            display: flex; align-items: center;
            padding: 0 20px; z-index: 100;
            border-bottom: 1px solid #CCFBF1;
        }
        .back-btn { 
            width: 42px; height: 42px; border-radius: 12px;
            background: #F0FDFA; border: none; color: var(--p);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; margin-right: 15px;
        }
        .header-title { font-weight: 800; font-size: 1.3rem; flex: 1; }
        .filter-btn {
            width: 42px; height: 42px; border-radius: 12px;
            background: #F0FDFA; border: none; color: var(--p);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
        }

        .content { margin-top: 90px; padding: 0 20px; }

        /* Category Tabs */
        .tabs-scroll {
            display: flex; gap: 10px; overflow-x: auto;
            padding-bottom: 15px; margin-bottom: 10px;
            scrollbar-width: none;
        }
        .tab-pill {
            padding: 10px 20px; border-radius: 24px;
            font-size: 0.85rem; font-weight: 600;
            background: white; color: #64748B;
            white-space: nowrap; cursor: pointer;
            border: 2px solid #E2E8F0; transition: all 0.2s;
        }
        .tab-pill.active {
            background: var(--p); color: white;
            border-color: var(--p);
        }

        /* Lead Cards */
        .lead-card {
            background: white; border-radius: 20px;
            padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .lead-card:hover { border-color: var(--p); }
        
        .lead-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 15px;
        }
        .lead-type {
            display: inline-flex; align-items: center; gap: 8px;
            background: #F0FDFA; padding: 6px 14px;
            border-radius: 20px; font-size: 0.8rem;
            font-weight: 700; color: var(--p);
        }
        .lead-urgency {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 700;
        }
        .urgency-high { background: #FEE2E2; color: #DC2626; }
        .urgency-medium { background: #FEF3C7; color: #D97706; }
        .urgency-low { background: #DCFCE7; color: #16A34A; }

        .lead-title { font-size: 1.1rem; font-weight: 700; color: #1E293B; margin-bottom: 8px; }
        
        .lead-details {
            display: flex; flex-wrap: wrap; gap: 12px;
            margin-bottom: 15px;
        }
        .detail-item {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.85rem; color: #64748B;
        }
        .detail-item i { color: var(--p); font-size: 0.9rem; }

        .lead-location {
            background: #F8FAFC; padding: 12px 15px;
            border-radius: 12px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 10px;
        }
        .lead-location i { color: #94A3B8; }
        .lead-location span { font-size: 0.9rem; color: #475569; }

        .lead-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 15px; border-top: 1px dashed #E2E8F0;
        }
        .lead-price {
            font-size: 1.4rem; font-weight: 800; color: var(--p);
        }
        .lead-price small {
            font-size: 0.75rem; color: #94A3B8; font-weight: 500;
        }
        .action-btns { display: flex; gap: 10px; }
        .btn-accept {
            background: var(--p); color: white;
            border: none; padding: 12px 24px;
            border-radius: 12px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-accept:hover { background: #0F766E; transform: translateY(-2px); }
        .btn-reject {
            background: #FEF2F2; color: #DC2626;
            border: 2px solid #FECACA; padding: 12px 20px;
            border-radius: 12px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-reject:hover { background: #FEE2E2; }

        /* Empty State */
        .empty-state {
            text-align: center; padding: 60px 20px;
            color: #94A3B8;
        }
        .empty-icon {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, #F1F5F9, #E2E8F0);
            border-radius: 50%; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px); z-index: 9999;
            display: none; align-items: flex-end; justify-content: center;
            padding: 0; opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .bottom-sheet {
            background: white; width: 100%; max-width: 480px;
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            max-height: 90vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .modal-overlay.active .bottom-sheet { transform: translateY(0); }
        
        .sheet-header {
            background: linear-gradient(135deg, var(--p), var(--p-light));
            color: white; padding: 25px 20px; position: relative;
        }
        .sheet-header::before {
            content: ''; position: absolute; top: 8px; left: 50%;
            transform: translateX(-50%); width: 40px; height: 4px;
            background: rgba(255,255,255,0.4); border-radius: 2px;
        }
        .sheet-close {
            position: absolute; top: 15px; right: 15px;
            width: 36px; height: 36px; background: rgba(255,255,255,0.2);
            border: none; border-radius: 50%; color: white;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .sheet-title { font-size: 1.3rem; font-weight: 700; margin-top: 10px; }
        .sheet-body { padding: 25px; overflow-y: auto; flex: 1; }

        .detail-row {
            display: flex; justify-content: space-between;
            padding: 15px 0; border-bottom: 1px solid #F1F5F9;
        }
        .detail-label { color: #64748B; font-size: 0.9rem; }
        .detail-value { color: #1E293B; font-weight: 600; font-size: 0.95rem; }

        .customer-card {
            background: #F8FAFC; padding: 20px;
            border-radius: 16px; margin: 20px 0;
        }
        .customer-header {
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
        }
        .customer-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, var(--p), var(--p-light));
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.3rem; font-weight: 700;
        }
        .customer-name { font-weight: 700; color: #1E293B; }
        .customer-phone { font-size: 0.85rem; color: #64748B; }

        .confirm-btn {
            width: 100%; padding: 16px;
            background: var(--p); color: white;
            border: none; border-radius: 14px;
            font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 10px; transition: all 0.2s;
        }
        .confirm-btn:hover { background: #0F766E; }

        /* Bottom Nav */
        .nav { 
            position: fixed; bottom: 0; width: 100%; height: 80px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid #CCFBF1;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding-bottom: 10px;
        }
        .nav-item { 
            text-align: center; color: #94A3B8; 
            font-size: 0.7rem; font-weight: 700;
            width: 70px; cursor: pointer; padding: 10px;
            border-radius: 16px; transition: all 0.2s;
        }
        .nav-item.active { 
            color: var(--p); background: #F0FDFA;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(13, 148, 136, 0.15);
        }
        .nav-item i { display: block; font-size: 1.5rem; margin-bottom: 4px; }

        /* Toast */
        .toast-container {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%); z-index: 10001;
            display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: white; padding: 16px 20px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 12px;
            min-width: 300px; max-width: 90vw;
            transform: translateY(-100px); opacity: 0;
            transition: all 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            pointer-events: all; border-left: 4px solid var(--p);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left-color: #22C55E; }
        .toast.error { border-left-color: #EF4444; }
        .toast-icon {
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0;
        }
        .toast.success .toast-icon { background: #DCFCE7; color: #22C55E; }
        .toast.error .toast-icon { background: #FEE2E2; color: #EF4444; }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" onclick="window.location.href='partner-dashboard.html'">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        <div class="header-title">New Leads</div>
        <button class="filter-btn" onclick="showFilter()">
            <i class="fa-solid fa-filter"></i>
        </button>
    </div>

    <div class="content">
        <!-- Category Tabs -->
        <div class="tabs-scroll">
            <div class="tab-pill active" onclick="filterLeads('all', this)">All Leads</div>
            <div class="tab-pill" onclick="filterLeads('painting', this)">Painting</div>
            <div class="tab-pill" onclick="filterLeads('waterproofing', this)">Waterproofing</div>
            <div class="tab-pill" onclick="filterLeads('ac', this)">AC Repair</div>
            <div class="tab-pill" onclick="filterLeads('plumbing', this)">Plumbing</div>
            <div class="tab-pill" onclick="filterLeads('electrician', this)">Electrician</div>
        </div>

        <!-- Leads List -->
        <div id="leadsList">
            <div class="empty-state">
                <div class="empty-icon"><i class="fa-solid fa-spinner fa-spin" style="color: var(--p);"></i></div>
                <p>Loading leads...</p>
            </div>
        </div>
    </div>

    <!-- Lead Detail Modal -->
    <div class="modal-overlay" id="leadModal">
        <div class="bottom-sheet">
            <div class="sheet-header">
                <button class="sheet-close" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <div class="sheet-title" id="modalTitle">Lead Details</div>
                <p id="modalSubtitle" style="opacity: 0.9; margin-top: 5px;">Review before accepting</p>
            </div>
            <div class="sheet-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div style="padding: 20px; border-top: 1px solid #E2E8F0;">
                <button class="confirm-btn" id="acceptBtn" onclick="acceptLead()">
                    <i class="fa-solid fa-check"></i> Accept Lead
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="nav">
        <div class="nav-item" onclick="window.location.href='partner-dashboard.html'">
            <i class="fa-solid fa-house"></i>Home
        </div>
        <div class="nav-item active" onclick="window.location.href='partner-leads.html'">
            <i class="fa-solid fa-bolt"></i>Leads
        </div>
        <div class="nav-item" onclick="window.location.href='partner-jobs.html'">
            <i class="fa-solid fa-briefcase"></i>Jobs
        </div>
        <div class="nav-item" onclick="window.location.href='partner-profile.html'">
            <i class="fa-solid fa-user"></i>Profile
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    
    <script>
    // --- 1. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
        authDomain: "urban-paint-pro.firebaseapp.com",
        databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "urban-paint-pro",
        storageBucket: "urban-paint-pro.firebasestorage.app",
        messagingSenderId: "929763117480",
        appId: "1:929763117480:web:560057baeb12672078b59d"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- 2. COST KEYWORDS (EXACT JO AAPNE DIYE) ---
    const categoryKeywords = {
        // PAINTING + WATERPROOFING COMBINED
        'painting': [
            // BRANDS
            'asian', 'berger', 'dulux', 'nerolac', 'paint', 
            'tractor', 'emulsion', 'apcolite', 'premium', 'royale', 'luxury', 'matt', 'aspira', 'glitz', 
            'ace', 'apex', 'weatherproof', 'ultima', 'protek', 
            'bison', 'rangoli', 'total', 'silk', 'glamor', 'breathe', 'easy', 'walmasta', 'weathercoat', 'long life',
            'supercover', 'velvet', 'touch', 'living', 'diamond', 'weathershield', 'powerflex',
            'beauty', 'smooth', 'pearls', 'impressions', 'eco', 'clean', 'excel', 'mica', 'marble', 'suraksha',
            
            // GENERAL TERMS
            'wall', 'texture', 'putty', 'primer', 'distemper', 'enamel', 'whitewash', 'interior', 'exterior',

            // WATERPROOFING TERMS
            'waterproof', 'leak', 'damp', 'seepage', 'terrace', 'roof', 'crack', 'tank', 
            'dr fixit', 'roofseal', 'raincoat', 'crack x', 'dampguard', 
            'smartcare', 'homeshield', 'seal-o-prime', 'coating', 'chemicals'
        ],

        'electrician': [
            'electric', 'fan', 'switch', 'socket', 'tube light', 'mcb', 'inverter', 
            'geyser', 'wiring', 'fault', 'chandelier', 'install', 'repair', 'light', 'current', 'power'
        ],

        'plumber': [
            'plumb', 'tap', 'washer', 'washbasin', 'blockage', 'sink', 'pipe', 
            'toilet', 'jet spray', 'water tank', 'shower', 'drain', 'leak', 'faucet', 'motor'
        ],

        'ac': [
            'ac ', 'air condition', 'split', 'window', 'gas', 'r32', 'r22', 
            'filling', 'pcb', 'compressor', 'cooling', 'service', 'install', 'uninstall'
        ],

        'cleaning': [
            'clean', 'deep', 'full home', '1bhk', '2bhk', '3bhk', 'bathroom', 
            'kitchen', 'sofa', 'carpet', 'fridge', 'dust', 'wash', 'mop', 'sanitiz'
        ],

        'carpenter': [
            'carpen', 'wood', 'door', 'lock', 'handle', 'drill', 'hang', 'hole', 
            'curtain', 'rod', 'drawer', 'channel', 'stopper', 'furniture', 'assembly', 'bed', 'dismantle', 'cupboard'
        ],

        'pest': [
            'pest', 'cockroach', 'termite', 'bed bug', 'rat', 'mouse', 
            'control', 'insect', 'spray', 'herbal', 'ant'
        ]
    };

    let currentPartnerId = null;
    let partnerCategory = null;
    let selectedLeadId = null;
    let selectedLeadData = null;

    // --- 3. AUTH & PROFILE LOAD ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentPartnerId = user.uid;
            
            // Partner ka category check karo
            db.ref(`partners/${user.uid}`).once('value').then(snap => {
                const profile = snap.val();
                if(profile && profile.category) {
                    partnerCategory = profile.category.toLowerCase();
                    console.log("Partner Category:", partnerCategory);
                    loadLeadsDirectlyFromOrders(); // Leads load karo
                } else {
                    document.getElementById('leadsList').innerHTML = '<div class="empty-state"><p>Profile Category Missing</p></div>';
                }
            });
        } else {
            window.location.href = 'partner-login.html';
        }
    });

    // --- 4. LOAD LEADS (DIRECT FROM ORDERS) ---
    function loadLeadsDirectlyFromOrders() {
        // Hum seedha 'orders' table read kar rahe hain jahan status 'pending' hai
        db.ref('orders').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
            const orders = snapshot.val() || {};
            renderFilteredLeads(orders);
        });
    }

    // --- 5. SMART FILTERING LOGIC ---
    function renderFilteredLeads(orders) {
        const list = document.getElementById('leadsList');
        const orderEntries = Object.entries(orders).reverse(); // Newest first

        let hasLeads = false;
        let html = '';

        orderEntries.forEach(([orderId, order]) => {
            // Check agar order service name humare keywords se match karta hai
            const isRelevant = checkServiceRelevance(order.service);

            if (isRelevant) {
                hasLeads = true;
                
                // Urgency Logic (Optional)
                let urgency = 'medium';
                if(order.service.toLowerCase().includes('leak') || order.service.toLowerCase().includes('fault')) {
                    urgency = 'high';
                }

                html += `
                    <div class="lead-card" onclick="openLeadModal('${orderId}')">
                        <div class="lead-header">
                            <span class="lead-type">
                                <i class="fa-solid fa-briefcase"></i> ${partnerCategory.toUpperCase()} LEAD
                            </span>
                            <span class="lead-urgency urgency-${urgency}">
                                ${urgency === 'high' ? 'Urgent' : 'New'}
                            </span>
                        </div>
                        
                        <div class="lead-title">${order.service}</div>
                        
                        <div class="lead-details">
                            <div class="detail-item"><i class="fa-solid fa-calendar"></i> ${order.slot?.date || 'Date N/A'}</div>
                            <div class="detail-item"><i class="fa-solid fa-clock"></i> ${order.slot?.time || 'Time N/A'}</div>
                            <div class="detail-item"><i class="fa-solid fa-location-dot"></i> ${order.customer?.area || 'Area N/A'}</div>
                        </div>

                        <div class="lead-footer">
                            <div class="lead-price">₹${(order.total || 0).toLocaleString()}</div>
                            <div class="action-btns">
                                <button class="btn-accept" onclick="event.stopPropagation(); acceptOrder('${orderId}')">
                                    Accept Job
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        if (!hasLeads) {
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"><i class="fa-solid fa-filter" style="color: #CBD5E1;"></i></div>
                    <h3>No leads found</h3>
                    <p>Waiting for <b>${partnerCategory}</b> orders.</p>
                </div>
            `;
        } else {
            list.innerHTML = html;
        }
    }

    // --- KEYWORD CHECKER ---
    function checkServiceRelevance(serviceName) {
        if (!serviceName || !partnerCategory) return false;
        const sName = serviceName.toLowerCase();
        
        // Agar partner ke category ke liye keywords defined hain
        if (categoryKeywords[partnerCategory]) {
            // Check karo agar service name mein koi bhi keyword maujood hai
            return categoryKeywords[partnerCategory].some(keyword => sName.includes(keyword.toLowerCase()));
        }
        return false;
    }

    // --- 6. ACCEPT ORDER & SYNC ---
    function acceptOrder(orderId) {
        // Fetch order details first
        db.ref(`orders/${orderId}`).once('value').then(snap => {
            const orderData = snap.val();
            if(!orderData) return;

            if(!confirm("Accept this job for ₹" + (orderData.total || 0) + "?")) return;

            const updates = {};
            
            // A. Update GLOBAL Order (Customer ko dikhega "Partner Assigned")
            updates[`orders/${orderId}/status`] = 'assigned';
            updates[`orders/${orderId}/partnerId`] = currentPartnerId;
            
            // B. Update USER Order (Backup sync)
            if(orderData.userId) {
                updates[`users/${orderData.userId}/orders/${orderId}/status`] = 'assigned';
                updates[`users/${orderData.userId}/orders/${orderId}/partnerId`] = currentPartnerId;
            }
            
            // C. Create PARTNER Job
            updates[`partnerJobs/${currentPartnerId}/${orderId}`] = {
                ...orderData,
                status: 'scheduled',
                acceptedAt: firebase.database.ServerValue.TIMESTAMP,
                startOtp: Math.floor(1000 + Math.random() * 9000)
            };

            // Run updates
            db.ref().update(updates).then(() => {
                showToast("Job Accepted Successfully!", "success");
                // Thoda delay taaki toast dikh sake
                setTimeout(() => window.location.href = 'partner-jobs.html', 1000);
            });
        });
    }

    // --- UTILS ---
    function showToast(msg, type) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<div style="font-weight:700;">${type=='success'?'Success':'Info'}</div><div>${msg}</div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => toast.remove(), 4000);
    }

    // Open Modal Logic (Simplified)
    function openLeadModal(orderId) {
         db.ref(`orders/${orderId}`).once('value').then(snap => {
            selectedLeadData = snap.val();
            selectedLeadId = orderId;
            document.getElementById('modalTitle').textContent = selectedLeadData.service;
            
            // Populate modal body details here...
            document.getElementById('leadModal').classList.add('active');
         });
    }
</script>
</body>
</html>
            
