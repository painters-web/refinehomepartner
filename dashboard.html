<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Dashboard - RefineHome</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #0D9488; --bg: #F0FDFA; --text: #134e4a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); min-height: 100vh; padding-bottom: 90px; color: var(--text); }
        
        .header { 
            position: fixed; top: 0; left: 0; right: 0; height: 70px; 
            background: white; display: flex; align-items: center; justify-content: center; 
            z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        .header h2 { color: var(--primary); font-weight: 800; font-size: 1.4rem; }
        .category-tag {
            position: absolute; right: 20px; top: 25px;
            font-size: 0.75rem; background: #E0F2FE; color: #0284C7; 
            padding: 4px 10px; border-radius: 12px; font-weight: 700;
        }

        .content { margin-top: 90px; padding: 0 20px; max-width: 800px; margin-left: auto; margin-right: auto; }

        .lead-card { 
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border-left: 5px solid var(--primary); 
            position: relative; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .status-badge { 
            position: absolute; top: 20px; right: 20px; 
            background: #DCFCE7; color: #166534; padding: 5px 12px; 
            border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; 
        }
        
        .service-title { font-size: 1.2rem; font-weight: 800; color: #0f172a; margin-bottom: 8px; text-transform: capitalize; }
        .info-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; color: #64748b; font-size: 0.95rem; }
        .info-row i { width: 20px; text-align: center; color: var(--primary); }
        
        .lead-amount { 
            font-size: 1.4rem; font-weight: 800; margin: 15px 0; color: var(--primary); 
            background: #F0FDFA; display: inline-block; padding: 5px 15px; border-radius: 10px;
        }
        
        .btn-accept { 
            width: 100%; padding: 14px; background: linear-gradient(135deg, #0D9488, #14B8A6); 
            color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; 
            font-size: 1rem; box-shadow: 0 4px 10px rgba(13, 148, 136, 0.2);
        }

        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: white; 
            display: flex; justify-content: space-around; padding: 12px 0 20px; 
            border-top: 1px solid #f1f5f9; z-index: 100; 
        }
        .nav-item { 
            text-decoration: none; color: #94a3b8; text-align: center; 
            font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px; 
        }
        .nav-item i { font-size: 1.4rem; }
        .nav-item.active { color: var(--primary); }

        .loading-state { text-align: center; padding: 50px; color: #64748b; }
    </style>
</head>
<body>

    <header class="header">
        <h2>My Leads</h2>
        <div id="catDisplay" class="category-tag">Loading...</div>
    </header>

    <main class="content" id="mainContent">
        <div class="loading-state">
            <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--primary)"></i>
            <p style="margin-top:10px">Finding matching jobs...</p>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item active"><i class="fa-solid fa-house"></i>Home</a>
        <a href="earnings.html" class="nav-item"><i class="fa-solid fa-wallet"></i>Earnings</a>
        <a href="reviews.html" class="nav-item"><i class="fa-solid fa-star"></i>Reviews</a>
        <a href="kyc.html" class="nav-item"><i class="fa-solid fa-id-card"></i>KYC</a>
        <a href="profile.html" class="nav-item"><i class="fa-solid fa-user"></i>Profile</a>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
            authDomain: "urban-paint-pro.firebaseapp.com",
            databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "urban-paint-pro",
            storageBucket: "urban-paint-pro.firebasestorage.app",
            messagingSenderId: "929763117480",
            appId: "1:929763117480:web:560057baeb12672078b59d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let myCategory = "all";

        auth.onAuthStateChanged(async user => {
            if (!user) { window.location.href = 'index.html'; return; }
            currentUser = user;
            
            const pSnap = await db.ref(`partners/${user.uid}`).once('value');
            if(pSnap.val()) {
                myCategory = (pSnap.val().category || "all").toLowerCase();
                document.getElementById('catDisplay').textContent = myCategory.toUpperCase() + " PARTNER";
            }
            
            loadLeadsFromUsers();
        });

        function loadLeadsFromUsers() {
            db.ref('users').on('value', snapshot => {
                const users = snapshot.val() || {};
                let allLeads = [];

                // YAHAN HAI MAGIC: Har category ke liye keywords ki list
                // Agar painting wala hai to in sab words ko dhoondhega
     const categoryKeywords = {
      'painting': [
        // Brands
        'asian', 'berger', 'dulux', 'nerolac', 'paint', 
        // Asian Paints Products
        'tractor', 'emulsion', 'apcolite', 'premium', 'royale', 'luxury', 'matt', 'aspira', 'glitz', 
        'ace', 'apex', 'weatherproof', 'ultima', 'protek', 
        // Berger Products
        'bison', 'rangoli', 'total', 'silk', 'glamor', 'breathe', 'easy', 'walmasta', 'weathercoat', 'long life',
        // Dulux Products
        'supercover', 'velvet', 'touch', 'living', 'diamond', 'weathershield', 'powerflex',
        // Nerolac Products
        'beauty', 'smooth', 'pearls', 'impressions', 'eco', 'clean', 'excel', 'mica', 'marble', 'suraksha',
        // General Terms
        'wall', 'texture', 'putty', 'primer', 'distemper', 'enamel', 'whitewash', 'interior', 'exterior'
        // Dr Fixit & Brands
        'dr fixit', 'roofseal', 'raincoat', 'crack x', 'dampguard', 'smartcare', 'homeshield', 'seal-o-prime',
        // Services
        'waterproof', 'leak', 'damp', 'seepage', 'terrace', 'roof', 'wall dampness', 'tank', 'coating', 'crack filling'
    ],

    'electrician': [
        'electric', 'fan', 'switch', 'socket', 'tube light', 'mcb', 'inverter', 
        'geyser', 'wiring', 'fault', 'chandelier', 'install', 'repair', 'light', 'current', 'power'
    ],

    'plumber': [
        'plumb', 'tap', 'washer', 'washbasin', 'blockage', 'sink', 'pipe', 
        'toilet', 'jet spray', 'water tank', 'shower', 'drain', 'leak', 'faucet', 'motor'
    ],

    'ac': [
        'ac ', 'air condition', 'split', 'window', 'gas', 'r32', 'r22', 
        'filling', 'pcb', 'compressor', 'cooling', 'service', 'install', 'uninstall'
    ],

    'cleaning': [
        'clean', 'deep', 'full home', '1bhk', '2bhk', '3bhk', 'bathroom', 
        'kitchen', 'sofa', 'carpet', 'fridge', 'dust', 'wash', 'mop', 'sanitiz'
    ],

    'carpenter': [
        'carpen', 'wood', 'door', 'lock', 'handle', 'drill', 'hang', 'hole', 
        'curtain', 'rod', 'drawer', 'channel', 'stopper', 'furniture', 'assembly', 'bed', 'dismantle', 'cupboard'
    ],

    'pest': [
        'pest', 'cockroach', 'termite', 'bed bug', 'rat', 'mouse', 
        'control', 'insect', 'spray', 'herbal', 'ant'
    ]
};


                Object.keys(users).forEach(userId => {
                    const userData = users[userId];
                    if (userData.orders) {
                        Object.keys(userData.orders).forEach(orderId => {
                            const order = userData.orders[orderId];
                            
                            const isNew = order.status === 'pending' || order.status === 'new';
                            const serviceName = (order.service || "").toLowerCase();
                            
                            // MATCHING LOGIC
                            let isMatch = false;
                            
                            if (myCategory === 'all') {
                                isMatch = true;
                            } else {
                                // Apni category ke keywords nikaalo
                                const myKeywords = categoryKeywords[myCategory] || [myCategory];
                                
                                // Check karo ki service name mein koi bhi keyword match ho raha hai kya
                                if (myKeywords.some(keyword => serviceName.includes(keyword))) {
                                    isMatch = true;
                                }
                            }

                            if (isNew && isMatch) {
                                allLeads.push({
                                    id: orderId,
                                    customerId: userId,
                                    ...order
                                });
                            }
                        });
                    }
                });

                renderLeads(allLeads);
            });
        }

        function renderLeads(leads) {
            const container = document.getElementById('mainContent');
            
            if (leads.length === 0) {
                container.innerHTML = `
                    <div class="loading-state">
                        <i class="fa-solid fa-filter" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <h3>No matching jobs</h3>
                        <p>Scanning for <strong>${myCategory.toUpperCase()}</strong> related jobs...</p>
                        <p style="font-size:0.8rem; margin-top:10px; color:#ef4444;">(Filtered by service name)</p>
                    </div>`;
                return;
            }

            let html = '';
            leads.reverse().forEach(lead => {
                html += `
                    <div class="lead-card">
                        <span class="status-badge">New Request</span>
                        <div class="service-title">${lead.service || "Service Request"}</div>
                        
                        <div class="info-row">
                            <i class="fa-regular fa-calendar"></i> 
                            <span>${lead.slot?.date || "Date TBD"}</span>
                        </div>
                        
                        <div class="info-row">
                            <i class="fa-solid fa-location-dot"></i> 
                            <span>${lead.customer?.address || lead.address || "Address in details"}</span>
                        </div>

                        <div class="lead-amount">â‚¹${lead.total || 0}</div>
                        
                        <button class="btn-accept" onclick="acceptJob('${lead.customerId}', '${lead.id}')">
                            Accept Job
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.acceptJob = async function(customerId, orderId) {
            if (!confirm("Confirm to accept this job?")) return;
            
            try {
                const pNameSnap = await db.ref(`partners/${currentUser.uid}/name`).once('value');
                const partnerName = pNameSnap.val() || "RefineHome Partner";

                await db.ref(`users/${customerId}/orders/${orderId}`).update({
                    status: 'assigned',
                    partnerId: currentUser.uid,
                    partnerName: partnerName,
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP
                });

                alert("Job Accepted Successfully!");
            } catch (e) {
                alert("Error: " + e.message);
            }
        }
    </script>
</body>
</html>
