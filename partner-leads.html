<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Leads</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use standard CSS from dashboard */
        :root { --p: #0D9488; --bg: #F0FDFA; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 80px; }
        .lead-card { background: white; margin: 15px; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; }
    </style>
</head>
<body>

    <h2 style="padding:20px; color:#134E4A;">Available Leads</h2>
    <div id="leadsList">
        <p style="text-align:center;">Loading leads for your category...</p>
    </div>

    <div class="nav">
        <div onclick="window.location.href='partner-dashboard.html'"><i class="fa-solid fa-house"></i></div>
        <div onclick="window.location.href='partner-leads.html'" style="color:var(--p);"><i class="fa-solid fa-bolt"></i></div>
        <div onclick="window.location.href='partner-jobs.html'"><i class="fa-solid fa-briefcase"></i></div>
        <div onclick="window.location.href='partner-profile.html'"><i class="fa-solid fa-user"></i></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8", authDomain: "urban-paint-pro.firebaseapp.com", databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/", projectId: "urban-paint-pro", storageBucket: "urban-paint-pro.firebasestorage.app", messagingSenderId: "929763117480", appId: "1:929763117480:web:560057baeb12672078b59d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let partner = JSON.parse(localStorage.getItem('partnerData'));
        if(!partner) window.location.href = 'partner-index.html';

        if(partner.kycStatus !== 'verified') {
            document.getElementById('leadsList').innerHTML = '<p style="text-align:center; color:red;">Please complete KYC verification first.</p>';
        } else {
            loadLeads();
        }

        function loadLeads() {
            db.ref('orders').orderByChild('status').equalTo('pending').on('value', snap => {
                const list = document.getElementById('leadsList');
                list.innerHTML = '';
                
                let hasLeads = false;
                snap.forEach(child => {
                    const order = child.val();
                    const id = child.key;

                    // STRICT CATEGORY CHECK
                    if(order.category === partner.category) {
                        hasLeads = true;
                        list.innerHTML += `
                            <div class="lead-card">
                                <h3>${order.service}</h3>
                                <div style="color:#64748B; margin-bottom:10px;">
                                    <i class="fa-solid fa-location-dot"></i> ${order.customer.area}<br>
                                    <i class="fa-regular fa-clock"></i> ${order.slot?.date || 'Flexible'}
                                </div>
                                <div style="font-weight:700; font-size:1.2rem; color:var(--p); margin-bottom:15px;">
                                    â‚¹${order.total}
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button onclick="acceptLead('${id}')" style="flex:1; background:var(--p); color:white; border:none; padding:10px; border-radius:8px;">Accept</button>
                                    <button onclick="this.parentElement.parentElement.style.display='none'" style="background:#FEE2E2; color:#DC2626; border:none; padding:10px 15px; border-radius:8px;"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                        `;
                    }
                });

                if(!hasLeads) list.innerHTML = '<p style="text-align:center; color:#94A3B8;">No leads available for your category currently.</p>';
            });
        }

        function acceptLead(id) {
            // Update Order Status
            db.ref(`orders/${id}`).update({
                status: 'accepted',
                assignedPartner: {
                    id: partner.id,
                    name: partner.name,
                    phone: partner.phone,
                    rating: partner.rating
                }
            }).then(() => {
                // Add to Partner's My Jobs
                db.ref(`partners/${partner.id}/jobs/${id}`).set({
                    status: 'accepted',
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP
                });
                alert("Lead Accepted! Check My Jobs tab.");
            });
        }
    </script>
</body>
</html>
