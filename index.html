<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0D9488">
    <title>Partner Login | Refine Home Painting</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #0D9488; --p-light: #14B8A6; --bg: #F0FDFA; --text: #134E4A; --white: #FFFFFF; --error: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

        /* Permission Screen */
        #permission-screen {
            position: fixed; inset: 0; background: white; z-index: 10000;
            display: flex; flex-direction: column; padding: 30px 20px;
        }
        .perm-header { text-align: center; margin-bottom: 30px; }
        .perm-logo {
            width: 80px; height: 80px; background: linear-gradient(135deg, var(--p), var(--p-light));
            border-radius: 20px; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 2rem;
        }
        .perm-title { font-size: 1.5rem; font-weight: 800; color: #1E293B; margin-bottom: 8px; }
        .perm-subtitle { color: #64748B; font-size: 0.95rem; }

        .perm-list { flex: 1; }
        .perm-item {
            display: flex; align-items: center; gap: 15px;
            background: #F8FAFC; padding: 20px; border-radius: 16px;
            margin-bottom: 15px; border: 2px solid #E2E8F0;
        }
        .perm-icon {
            width: 50px; height: 50px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem;
        }
        .perm-icon.location { background: #DBEAFE; color: #2563EB; }
        .perm-icon.phone { background: #DCFCE7; color: #16A34A; }
        .perm-icon.camera { background: #FEF3C7; color: #D97706; }
        .perm-icon.notifications { background: #F0FDFA; color: var(--p); }
        .perm-content { flex: 1; }
        .perm-name { font-weight: 700; color: #1E293B; margin-bottom: 3px; }
        .perm-desc { font-size: 0.8rem; color: #64748B; }
        .perm-status {
            width: 28px; height: 28px; border-radius: 50%;
            border: 2px solid #CBD5E1; display: flex;
            align-items: center; justify-content: center;
            font-size: 0.8rem; color: #CBD5E1;
        }
        .perm-status.granted { background: #22C55E; border-color: #22C55E; color: white; }

        .perm-btn {
            width: 100%; padding: 18px;
            background: var(--p); color: white;
            border: none; border-radius: 14px;
            font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 10px;
        }
        .perm-btn:disabled { background: #CBD5E1; cursor: not-allowed; }

        /* Login Screen */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(180deg, #F0FDFA 0%, #FFFFFF 100%);
            display: none; flex-direction: column; padding: 20px;
            overflow-y: auto;
        }
        .login-header { text-align: center; margin: 40px 0 30px; }
        .login-logo {
            width: 90px; height: 90px; background: linear-gradient(135deg, var(--p), var(--p-light));
            border-radius: 24px; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 2.5rem; box-shadow: 0 10px 30px rgba(13,148,136,0.3);
        }
        .partner-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: linear-gradient(135deg, var(--p), var(--p-light));
            color: white; padding: 8px 20px;
            border-radius: 20px; font-size: 0.85rem; font-weight: 700;
            margin-bottom: 15px;
        }
        .login-title { font-size: 1.6rem; font-weight: 800; color: #1E293B; }
        .login-subtitle { color: #64748B; margin-top: 8px; }

        /* Login Tabs */
        .login-tabs {
            display: flex; background: #F1F5F9;
            border-radius: 12px; padding: 4px; margin-bottom: 25px;
        }
        .login-tab {
            flex: 1; padding: 12px; text-align: center;
            font-weight: 600; font-size: 0.9rem; color: #64748B;
            border-radius: 10px; cursor: pointer; transition: all 0.2s;
        }
        .login-tab.active { background: white; color: var(--p); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* Form Views */
        .form-view { display: none; }
        .form-view.active { display: block; }

        .input-group { margin-bottom: 15px; position: relative; }
        .input-field {
            width: 100%; padding: 16px 16px 16px 50px;
            border: 2px solid #E2E8F0; border-radius: 14px;
            outline: none; font-size: 1rem; background: white;
            transition: all 0.2s;
        }
        .input-field:focus { border-color: var(--p); box-shadow: 0 0 0 4px rgba(13,148,136,0.1); }
        .input-icon { position: absolute; left: 18px; top: 18px; color: var(--p); font-size: 1.1rem; }
        .input-toggle {
            position: absolute; right: 18px; top: 18px;
            color: #94A3B8; cursor: pointer;
        }

        .btn {
            width: 100%; padding: 16px; border-radius: 14px;
            border: none; font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 10px; transition: all 0.2s;
        }
        .btn-primary { background: var(--p); color: white; }
        .btn-primary:hover { background: #0F766E; transform: translateY(-2px); }
        .btn-google { background: white; border: 2px solid #E2E8F0; color: #1E293B; }
        .btn-google:hover { border-color: var(--p); }
        .btn-phone { background: #F59E0B; color: white; }

        .divider { text-align: center; margin: 20px 0; color: #94A3B8; font-size: 0.8rem; position: relative; }
        .divider::before, .divider::after { content: ''; position: absolute; top: 50%; width: 40%; height: 1px; background: #E2E8F0; }
        .divider::before { left: 0; } .divider::after { right: 0; }

        .signup-link {
            text-align: center; margin-top: 20px;
            color: #64748B; font-size: 0.9rem;
        }
        .signup-link a { color: var(--p); font-weight: 700; text-decoration: none; }

        /* Phone Input */
        .phone-input-group { display: flex; gap: 10px; }
        .phone-prefix {
            padding: 16px; background: #F1F5F9;
            border-radius: 14px; font-weight: 700; display: flex; align-items: center;
        }
        .phone-input-group input { flex: 1; }

        /* OTP Input */
        .otp-container { display: none; }
        .otp-inputs { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .otp-input {
            width: 55px; height: 60px; border: 2px solid #E2E8F0;
            border-radius: 14px; text-align: center; font-size: 1.5rem;
            font-weight: 700; outline: none; transition: all 0.2s;
        }
        .otp-input:focus { border-color: var(--p); }

        /* Toast */
        .toast-container {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%); z-index: 10001;
            display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: white; padding: 16px 20px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 12px;
            min-width: 300px; max-width: 90vw;
            transform: translateY(-100px); opacity: 0;
            transition: all 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            pointer-events: all; border-left: 4px solid var(--p);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left-color: #22C55E; }
        .toast.error { border-left-color: #EF4444; }
        .toast-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .toast.success .toast-icon { background: #DCFCE7; color: #22C55E; }
        .toast.error .toast-icon { background: #FEE2E2; color: #EF4444; }
    </style>
</head>
<body>

    <!-- Permission Screen -->
    <div id="permission-screen">
        <div class="perm-header">
            <div class="perm-logo"><i class="fa-solid fa-shield-halved"></i></div>
            <div class="perm-title">App Permissions</div>
            <div class="perm-subtitle">We need these permissions to provide you with the best experience</div>
        </div>

        <div class="perm-list">
            <div class="perm-item">
                <div class="perm-icon location"><i class="fa-solid fa-location-dot"></i></div>
                <div class="perm-content">
                    <div class="perm-name">Location Access</div>
                    <div class="perm-desc">To find nearby jobs and verify work location</div>
                </div>
                <div class="perm-status" id="locStatus"><i class="fa-solid fa-check"></i></div>
            </div>
            <div class="perm-item">
                <div class="perm-icon phone"><i class="fa-solid fa-phone"></i></div>
                <div class="perm-content">
                    <div class="perm-name">Phone State</div>
                    <div class="perm-desc">To verify your device and enable calls</div>
                </div>
                <div class="perm-status" id="phoneStatus"><i class="fa-solid fa-check"></i></div>
            </div>
            <div class="perm-item">
                <div class="perm-icon camera"><i class="fa-solid fa-camera"></i></div>
                <div class="perm-content">
                    <div class="perm-name">Camera Access</div>
                    <div class="perm-desc">To upload profile photo and work images</div>
                </div>
                <div class="perm-status" id="camStatus"><i class="fa-solid fa-check"></i></div>
            </div>
            <div class="perm-item">
                <div class="perm-icon notifications"><i class="fa-solid fa-bell"></i></div>
                <div class="perm-content">
                    <div class="perm-name">Notifications</div>
                    <div class="perm-desc">To alert you about new job leads</div>
                </div>
                <div class="perm-status" id="notifStatus"><i class="fa-solid fa-check"></i></div>
            </div>
        </div>

        <button class="perm-btn" id="grantBtn" onclick="requestPermissions()">
            <i class="fa-solid fa-check-double"></i> Grant All Permissions
        </button>
    </div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-header">
            <div class="login-logo"><i class="fa-solid fa-paint-roller"></i></div>
            <div class="partner-badge"><i class="fa-solid fa-briefcase"></i> PARTNER PORTAL</div>
            <div class="login-title">Welcome Back!</div>
            <div class="login-subtitle">Login to access your partner dashboard</div>
        </div>

        <div class="login-tabs">
            <div class="login-tab active" onclick="switchTab('email', this)">Email</div>
            <div class="login-tab" onclick="switchTab('phone', this)">Phone</div>
            <div class="login-tab" onclick="switchTab('google', this)">Google</div>
        </div>

        <!-- Email Login -->
        <div id="email-view" class="form-view active">
            <div class="input-group">
                <i class="fa-solid fa-envelope input-icon"></i>
                <input type="email" id="emailInput" class="input-field" placeholder="Enter your email">
            </div>
            <div class="input-group">
                <i class="fa-solid fa-lock input-icon"></i>
                <input type="password" id="passwordInput" class="input-field" placeholder="Enter your password">
                <i class="fa-solid fa-eye input-toggle" onclick="togglePassword()"></i>
            </div>
            <button class="btn btn-primary" onclick="loginWithEmail()">
                <i class="fa-solid fa-arrow-right"></i> Login
            </button>
            <p style="text-align: center; margin-top: 15px;">
                <a href="#" style="color: var(--p); font-size: 0.9rem; font-weight: 600;">Forgot Password?</a>
            </p>
        </div>

        <!-- Phone Login -->
        <div id="phone-view" class="form-view">
            <div class="input-group">
                <div class="phone-input-group">
                    <span class="phone-prefix">+91</span>
                    <input type="tel" id="phoneInput" class="input-field" placeholder="98765 43210" maxlength="10">
                </div>
            </div>
            <div id="recaptcha-container"></div>
            <button class="btn btn-phone" id="sendOtpBtn" onclick="sendOTP()">
                <i class="fa-solid fa-paper-plane"></i> Send OTP
            </button>
            
            <div class="otp-container" id="otpContainer">
                <p style="text-align: center; color: #64748B; margin-bottom: 10px;">Enter 6-digit OTP</p>
                <div class="otp-inputs">
                    <input type="text" class="otp-input" maxlength="1" onkeyup="moveOtp(this, 1)">
                    <input type="text" class="otp-input" maxlength="1" onkeyup="moveOtp(this, 2)">
                    <input type="text" class="otp-input" maxlength="1" onkeyup="moveOtp(this, 3)">
                    <input type="text" class="otp-input" maxlength="1" onkeyup="moveOtp(this, 4)">
                    <input type="text" class="otp-input" maxlength="1" onkeyup="moveOtp(this, 5)">
                    <input type="text" class="otp-input" maxlength="1" onkeyup="moveOtp(this, 6)">
                </div>
                <button class="btn btn-primary" onclick="verifyOTP()">
                    <i class="fa-solid fa-check"></i> Verify & Login
                </button>
            </div>
        </div>

        <!-- Google Login -->
        <div id="google-view" class="form-view">
            <button class="btn btn-google" onclick="loginWithGoogle()" style="padding: 18px;">
                <img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" width="24">
                Continue with Google
            </button>
            <p style="text-align: center; color: #64748B; font-size: 0.85rem; margin-top: 15px;">
                By continuing, you agree to our Terms & Privacy Policy
            </p>
        </div>

        <div class="signup-link">
            Don't have an account? <a href="partner-signup.html">Create Account</a>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
            authDomain: "urban-paint-pro.firebaseapp.com",
            databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "urban-paint-pro",
            storageBucket: "urban-paint-pro.firebasestorage.app",
            messagingSenderId: "929763117480",
            appId: "1:929763117480:web:560057baeb12672078b59d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        let permissionsGranted = { location: false, phone: true, camera: false, notifications: false };
        let confirmationResult = null;

        // Check if permissions already granted
        if (localStorage.getItem('permissionsGranted') === 'true') {
            showLoginScreen();
        }

        function requestPermissions() {
            // Request Location
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        permissionsGranted.location = true;
                        document.getElementById('locStatus').classList.add('granted');
                        checkAllPermissions();
                    },
                    (err) => {
                        showToast('Location permission required for job matching', 'error');
                    }
                );
            }

            // Request Notification
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        permissionsGranted.notifications = true;
                        document.getElementById('notifStatus').classList.add('granted');
                    }
                    checkAllPermissions();
                });
            }

            // Camera and Phone are auto-granted for demo
            permissionsGranted.phone = true;
            permissionsGranted.camera = true;
            document.getElementById('phoneStatus').classList.add('granted');
            document.getElementById('camStatus').classList.add('granted');

            setTimeout(checkAllPermissions, 1000);
        }

        function checkAllPermissions() {
            const allGranted = Object.values(permissionsGranted).every(v => v);
            if (allGranted || permissionsGranted.location) {
                localStorage.setItem('permissionsGranted', 'true');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('permission-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-view').forEach(v => v.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(tab + '-view').classList.add('active');
        }

        function togglePassword() {
            const input = document.getElementById('passwordInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function moveOtp(input, index) {
            if (input.value.length === 1 && index < 6) {
                document.querySelectorAll('.otp-input')[index].focus();
            }
        }

        // Email Login
        function loginWithEmail() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(() => checkPartnerStatus())
                .catch(e => showToast(e.message, 'error'));
        }

        // Google Login
        function loginWithGoogle() {
            auth.signInWithPopup(googleProvider)
                .then(() => checkPartnerStatus())
                .catch(e => showToast(e.message, 'error'));
        }

        // Phone Login
        function sendOTP() {
            const phone = document.getElementById('phoneInput').value;
            if (!phone || phone.length < 10) {
                showToast('Enter valid phone number', 'error');
                return;
            }

            if (!window.recaptchaVerifier) {
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible'
                });
            }

            auth.signInWithPhoneNumber('+91' + phone, window.recaptchaVerifier)
                .then((result) => {
                    confirmationResult = result;
                    document.getElementById('otpContainer').style.display = 'block';
                    document.getElementById('sendOtpBtn').style.display = 'none';
                    showToast('OTP sent!', 'success');
                }).catch(e => showToast(e.message, 'error'));
        }

        function verifyOTP() {
            const inputs = document.querySelectorAll('.otp-input');
            const code = Array.from(inputs).map(i => i.value).join('');
            
            if (code.length !== 6) {
                showToast('Please enter complete OTP', 'error');
                return;
            }

            confirmationResult.confirm(code)
                .then(() => checkPartnerStatus())
                .catch(e => showToast('Invalid OTP', 'error'));
        }

        // Check Partner Status
        function checkPartnerStatus() {
            const user = auth.currentUser;
            if (!user) return;

            db.ref('partners/' + user.uid).once('value').then((snapshot) => {
                const partner = snapshot.val();
                if (!partner) {
                    // New partner - redirect to signup
                    window.location.href = 'partner-signup.html';
                } else if (partner.kycStatus === 'pending' || partner.kycStatus === 'processing') {
                    window.location.href = 'partner-kyc-status.html';
                } else if (partner.kycStatus === 'rejected') {
                    showToast('KYC rejected. Please re-submit.', 'error');
                    window.location.href = 'partner-kyc.html';
                } else {
                    window.location.href = 'partner-home.html';
                }
            });
        }

        // Toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: 'fa-circle-check', error: 'fa-circle-xmark', info: 'fa-circle-info' };
            toast.innerHTML = `
                <div class="toast-icon"><i class="fa-solid ${icons[type]}"></i></div>
                <div>
                    <div style="font-weight: 700; color: #1E293B; font-size: 0.95rem;">${type === 'success' ? 'Success!' : 'Error!'}</div>
                    <div style="color: #64748B; font-size: 0.85rem;">${message}</div>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 4000);
        }
    </script>
</body>
</html>
