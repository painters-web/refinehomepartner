<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Leads | Refine Home</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --p: #0D9488; --bg: #F0FDFA; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 90px; }
        .header { background: white; padding: 20px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; font-weight: 800; font-size: 1.2rem; }
        .lead-card { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 6px solid var(--p); }
        .btn-accept { width: 100%; background: var(--p); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 700; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">Partner Leads</div>
    <div id="leadsList"><div style="text-align:center; padding:50px; color:#94A3B8;">Searching for leads...</div></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
            authDomain: "urban-paint-pro.firebaseapp.com",
            databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "urban-paint-pro",
            storageBucket: "urban-paint-pro.firebasestorage.app",
            messagingSenderId: "929763117480",
            appId: "1:929763117480:web:560057baeb12672078b59d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const categoryKeywords = {
            'painting': ['paint', 'tractor', 'asian', 'wall', 'water', 'leak', 'putty', 'texture', 'dr fixit', 'royal'],
            'electrician': ['electric', 'fan', 'switch'],
            'plumber': ['plumb', 'tap', 'pipe']
        };

        let myCategory = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                db.ref('partners/' + user.uid).on('value', snap => {
                    const data = snap.val();
                    if(data) {
                        myCategory = (data.category || "").toLowerCase();
                        loadLeads();
                    }
                });
            } else { window.location.href = 'index.html'; }
        });

        function loadLeads() {
            // FIX: "orders" table check
            db.ref('orders').orderByChild('status').equalTo('pending').on('value', snapshot => {
                const orders = snapshot.val() || {};
                const list = document.getElementById('leadsList');
                let html = '';
                let found = false;

                Object.entries(orders).reverse().forEach(([id, order]) => {
                    const sName = (order.service || "").toLowerCase();
                    
                    // Matching Logic
                    let isMatch = false;
                    if (myCategory === 'painting') {
                        isMatch = categoryKeywords.painting.some(k => sName.includes(k));
                    } else if (myCategory && sName.includes(myCategory)) {
                        isMatch = true;
                    }

                    if (isMatch) {
                        found = true;
                        html += `
                            <div class="lead-card">
                                <div style="font-weight:800; font-size:1.1rem; color:#1E293B;">${order.service}</div>
                                <div style="margin:10px 0; color:#64748B; font-size:0.9rem;">
                                    <i class="fa-solid fa-location-dot"></i> ${order.customer?.area || 'Local Area'} (${order.customer?.address || ''})
                                </div>
                                <div style="font-size:1.3rem; font-weight:800; color:var(--p);">â‚¹${order.total || 0}</div>
                                <button class="btn-accept">Accept Job</button>
                            </div>`;
                    }
                });

                list.innerHTML = found ? html : '<div style="text-align:center; padding:50px; color:#94A3B8;">No matching leads right now</div>';
            });
        }
    </script>
</body>
</html>
