<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p: #0D9488; --bg: #F0FDFA; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
        body { background:var(--bg); padding-bottom:90px; color:#134e4a; }
        .header { position:fixed; top:0; left:0; right:0; height:60px; background:white; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); z-index:100; }
        .content { margin-top:80px; padding:20px; max-width:600px; margin-left:auto; margin-right:auto; }
        
        .lead-card { background:white; padding:20px; border-radius:16px; margin-bottom:15px; box-shadow:0 4px 12px rgba(0,0,0,0.05); border-left:5px solid var(--p); position:relative; }
        .badge { position:absolute; top:15px; right:15px; background:#DCFCE7; color:#166534; padding:4px 10px; border-radius:12px; font-size:0.75rem; font-weight:700; }
        .s-title { font-size:1.1rem; font-weight:800; color:#0f172a; margin-bottom:5px; text-transform:capitalize; }
        .row { display:flex; align-items:center; gap:8px; font-size:0.9rem; color:#64748B; margin-bottom:5px; }
        .price { font-size:1.3rem; font-weight:800; color:var(--p); margin-top:10px; }
        .btn { width:100%; padding:12px; background:var(--p); color:white; border:none; border-radius:10px; font-weight:700; margin-top:12px; cursor:pointer; }
        
        .nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:12px 0; border-top:1px solid #eee; }
        .nav a { text-decoration:none; color:#94a3b8; font-size:0.7rem; display:flex; flex-direction:column; align-items:center; }
        .nav a.active { color:var(--p); }
        .nav i { font-size:1.4rem; margin-bottom:4px; }
    </style>
</head>
<body>
    <div class="header"><h3>My Leads</h3></div>
    
    <div class="content" id="main">
        <div style="text-align:center; margin-top:50px;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:2rem; color:#0D9488;"></i>
            <p style="margin-top:10px;">Finding leads...</p>
        </div>
    </div>

    <div class="nav">
        <a href="dashboard.html" class="active"><i class="fa-solid fa-house"></i>Home</a>
        <a href="earnings.html"><i class="fa-solid fa-wallet"></i>Earnings</a>
        <a href="reviews.html"><i class="fa-solid fa-star"></i>Reviews</a>
        <a href="kyc.html"><i class="fa-solid fa-id-card"></i>KYC</a>
        <a href="profile.html"><i class="fa-solid fa-user"></i>Profile</a>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
            authDomain: "urban-paint-pro.firebaseapp.com",
            databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "urban-paint-pro",
            storageBucket: "urban-paint-pro.firebasestorage.app",
            messagingSenderId: "929763117480",
            appId: "1:929763117480:web:560057baeb12672078b59d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        let myCategory = "";

        auth.onAuthStateChanged(async user => {
            if(!user) { window.location.href='index.html'; return; }
            
            // 1. Get Partner Category
            const snap = await db.ref(`partners/${user.uid}`).once('value');
            myCategory = (snap.val()?.category || "").toLowerCase();
            console.log("Partner Category:", myCategory);
            
            // 2. Start Deep Search for Leads
            findLeads();
        });

        function findLeads() {
            // Pehle 'orders' (Public) check karo
            db.ref('orders').on('value', snap => {
                const orders = snap.val();
                if (orders) {
                    render(orders);
                } else {
                    // Agar Public khali hai, to 'users' (Private) mein jasoosi karo (BACKUP PLAN)
                    searchInUsers(); 
                }
            });
        }

        function searchInUsers() {
            console.log("Searching in users node...");
            db.ref('users').once('value', snap => {
                const users = snap.val() || {};
                let foundOrders = {};
                
                // Har user ke andar ghus ke orders nikalo
                Object.keys(users).forEach(uid => {
                    if (users[uid].orders) {
                        Object.entries(users[uid].orders).forEach(([oid, order]) => {
                            // Sirf pending/new orders uthao
                            if (order.status === 'pending' || order.status === 'new') {
                                foundOrders[oid] = { ...order, userId: uid };
                            }
                        });
                    }
                });
                render(foundOrders);
            });
        }

        function render(list) {
            const container = document.getElementById('main');
            let html = "";
            let count = 0;

            Object.entries(list).reverse().forEach(([id, lead]) => {
                // FILTER LOGIC
                // 1. Status Check
                const isNew = lead.status === 'pending' || lead.status === 'new';
                
                // 2. Category Match
                const service = (lead.service || "").toLowerCase();
                // Agar service name mein partner ki category hai (Example: "Painting" in "Home Painting")
                const isMatch = service.includes(myCategory) || myCategory === "all";

                if (isNew && isMatch) {
                    count++;
                    html += `
                    <div class="lead-card">
                        <span class="badge">NEW LEAD</span>
                        <div class="s-title">${lead.service || "Service Request"}</div>
                        <div class="row"><i class="fa-solid fa-user"></i> Customer (ID: ${lead.userId ? lead.userId.slice(0,4) : 'User'})</div>
                        <div class="row"><i class="fa-solid fa-location-dot"></i> ${lead.customer?.address || lead.address || "Location TBD"}</div>
                        <div class="row"><i class="fa-regular fa-calendar"></i> ${lead.slot?.date || "Date TBD"}</div>
                        <div class="price">â‚¹${lead.total || "0"}</div>
                        <button class="btn" onclick="accept('${id}', '${lead.userId}')">Accept Job</button>
                    </div>`;
                }
            });

            if (count === 0) {
                container.innerHTML = `
                <div style="text-align:center; margin-top:60px; color:#94a3b8;">
                    <i class="fa-solid fa-filter-circle-xmark" style="font-size:3rem; opacity:0.3;"></i>
                    <h3>No leads found</h3>
                    <p>Waiting for <strong>${myCategory}</strong> bookings...</p>
                </div>`;
            } else {
                container.innerHTML = html;
            }
        }

        window.accept = async (oid, uid) => {
            if(confirm("Accept this job?")) {
                const pid = auth.currentUser.uid;
                // Update everywhere
                const updates = {};
                updates[`orders/${oid}/status`] = "assigned";
                updates[`orders/${oid}/partnerId`] = pid;
                if(uid) {
                    updates[`users/${uid}/orders/${oid}/status`] = "assigned";
                    updates[`users/${uid}/orders/${oid}/partnerId`] = pid;
                }
                await db.ref().update(updates);
                alert("Job Accepted!");
            }
        }
    </script>
</body>
</html>
