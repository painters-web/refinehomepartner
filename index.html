<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner Login | Refine Home Services</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --p: #0D9488; --bg: #F0FDFA; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #E2E8F0; border-radius: 10px; margin-top: 5px; }
        .btn { width: 100%; padding: 14px; background: var(--p); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-google { background: white; color: #333; border: 1px solid #E2E8F0; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="text-align:center; color:var(--p);">Partner App</h2>
        
        <div id="loginForm">
            <input type="email" id="l_email" class="input-field" placeholder="Email">
            <input type="password" id="l_pass" class="input-field" placeholder="Password">
            <button class="btn" onclick="login()">Login</button>
            <button class="btn btn-google" onclick="googleLogin()"><img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" width="20"> Login with Google</button>
            <p style="text-align:center; margin-top:15px; cursor:pointer; color:#64748B;" onclick="toggleForms()">New Partner? Register</p>
        </div>

        <div id="signupForm" style="display:none;">
            <input type="text" id="s_name" class="input-field" placeholder="Full Name">
            <input type="email" id="s_email" class="input-field" placeholder="Email">
            <input type="tel" id="s_phone" class="input-field" placeholder="Mobile Number">
            <select id="s_category" class="input-field">
                <option value="" disabled selected>Select Your Category</option>
                <option value="painting">Painting</option>
                <option value="cleaning">Cleaning</option>
                <option value="electrician">Electrician</option>
                <option value="plumber">Plumber</option>
                <option value="carpenter">Carpenter</option>
                <option value="ac">AC Repair</option>
                <option value="pest">Pest Control</option>
                <option value="waterproofing">Waterproofing</option>
            </select>
            <input type="text" id="s_city" class="input-field" placeholder="Work City">
            <input type="password" id="s_pass" class="input-field" placeholder="Password">
            <button class="btn" onclick="signup()">Register Partner</button>
            <p style="text-align:center; margin-top:15px; cursor:pointer; color:#64748B;" onclick="toggleForms()">Back to Login</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8",
            authDomain: "urban-paint-pro.firebaseapp.com",
            databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "urban-paint-pro",
            storageBucket: "urban-paint-pro.firebasestorage.app",
            messagingSenderId: "929763117480",
            appId: "1:929763117480:web:560057baeb12672078b59d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();

        function toggleForms() {
            const login = document.getElementById('loginForm');
            const signup = document.getElementById('signupForm');
            if(login.style.display === 'none') { login.style.display = 'block'; signup.style.display = 'none'; }
            else { login.style.display = 'none'; signup.style.display = 'block'; }
        }

        // --- SIGNUP LOGIC ---
        function signup() {
            const email = document.getElementById('s_email').value;
            const pass = document.getElementById('s_pass').value;
            const name = document.getElementById('s_name').value;
            const phone = document.getElementById('s_phone').value;
            const category = document.getElementById('s_category').value; // IMPORTANT
            const city = document.getElementById('s_city').value;

            if(!category) return alert("Please select a category");

            auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
                const user = cred.user;
                const partnerData = {
                    id: user.uid, name, email, phone, city: city.toLowerCase(),
                    category: category, // Saving Category
                    kycStatus: 'pending', // Default KYC Status
                    rating: 5.0, earnings: 0
                };
                db.ref('partners/' + user.uid).set(partnerData).then(() => {
                    localStorage.setItem('partnerData', JSON.stringify(partnerData));
                    window.location.href = 'partner-dashboard.html';
                });
            }).catch(e => alert(e.message));
        }

        // --- LOGIN LOGIC ---
        function login() {
            const email = document.getElementById('l_email').value;
            const pass = document.getElementById('l_pass').value;
            auth.signInWithEmailAndPassword(email, pass).then((cred) => handleAuth(cred.user))
                .catch(e => alert(e.message));
        }

        function googleLogin() {
            auth.signInWithPopup(provider).then((result) => {
                // Check if user exists in DB, if not, ask for category
                db.ref('partners/' + result.user.uid).once('value').then(snap => {
                    if(snap.exists()) handleAuth(result.user);
                    else alert("Google Login successful! But please register first to select category.");
                });
            }).catch(e => alert(e.message));
        }

        function handleAuth(user) {
            db.ref('partners/' + user.uid).once('value').then(snap => {
                if(snap.exists()) {
                    localStorage.setItem('partnerData', JSON.stringify(snap.val()));
                    window.location.href = 'partner-dashboard.html';
                } else alert("Partner profile not found.");
            });
        }
    </script>
</body>
</html>
