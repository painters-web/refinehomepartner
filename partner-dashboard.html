<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Refine Partner</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* (Use the CSS from your previous partner-dashboard file here) */
        :root { --p: #0D9488; --bg: #F0FDFA; --text: #134E4A; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 80px; margin:0; }
        .header { background: var(--p); color: white; padding: 20px; border-radius: 0 0 20px 20px; }
        .kyc-alert { background: #FFF7ED; color: #C2410C; padding: 10px; border-radius: 10px; margin: 15px; display: none; border: 1px solid #FFEDD5; text-align: center; }
        .lead-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; }
        .toggle-switch { width: 50px; height: 26px; background: rgba(255,255,255,0.3); border-radius: 13px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-switch.active { background: #22C55E; }
        .toggle-switch::after { content:''; position: absolute; left: 2px; top: 2px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.active::after { left: 26px; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2 id="pName">Hello!</h2>
                <p id="pCat" style="opacity:0.9; font-size:0.9rem;">Loading...</p>
            </div>
            <div class="toggle-switch" id="statusToggle" onclick="toggleOnline()"></div>
        </div>
    </div>

    <div id="kycBanner" class="kyc-alert" onclick="window.location.href='partner-profile.html'">
        <i class="fa-solid fa-triangle-exclamation"></i> KYC Pending! Complete verification to get jobs.
    </div>

    <h3 style="padding: 0 15px; margin-top: 20px;">New Leads (Your Category)</h3>
    <div id="leadsContainer">
        <div style="text-align:center; color:#94A3B8; margin-top:20px;">Go Online to see leads</div>
    </div>

    <div class="nav">
        <div onclick="window.location.href='partner-dashboard.html'" style="color:var(--p);"><i class="fa-solid fa-house"></i></div>
        <div onclick="window.location.href='partner-leads.html'"><i class="fa-solid fa-bolt"></i></div>
        <div onclick="window.location.href='partner-jobs.html'"><i class="fa-solid fa-briefcase"></i></div>
        <div onclick="window.location.href='partner-profile.html'"><i class="fa-solid fa-user"></i></div>
    </div>

    <script>
        // Firebase Config (Same as above)
        const firebaseConfig = { apiKey: "AIzaSyCmqBL6a0muExq2qBsSR6M3C_8AyXcJ2k8", authDomain: "urban-paint-pro.firebaseapp.com", databaseURL: "https://urban-paint-pro-default-rtdb.asia-southeast1.firebasedatabase.app/", projectId: "urban-paint-pro", storageBucket: "urban-paint-pro.firebasestorage.app", messagingSenderId: "929763117480", appId: "1:929763117480:web:560057baeb12672078b59d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let partner = JSON.parse(localStorage.getItem('partnerData'));
        if(!partner) window.location.href = 'partner-index.html';

        let isOnline = false;

        // Load Data
        document.getElementById('pName').innerText = `Hello ${partner.name.split(' ')[0]}!`;
        document.getElementById('pCat').innerText = `${partner.category.toUpperCase()} Expert`;

        // Check KYC
        if(partner.kycStatus !== 'verified') {
            document.getElementById('kycBanner').style.display = 'block';
        }

        function toggleOnline() {
            if(partner.kycStatus !== 'verified') return alert("Please complete KYC in Profile first!");
            
            isOnline = !isOnline;
            const t = document.getElementById('statusToggle');
            if(isOnline) {
                t.classList.add('active');
                listenForLeads();
            } else {
                t.classList.remove('active');
                stopListening();
            }
        }

        function listenForLeads() {
            document.getElementById('leadsContainer').innerHTML = '<p style="text-align:center;">Searching for leads...</p>';
            
            // LOGIC: Sirf wahi orders suno jo pending hain
            db.ref('orders').orderByChild('status').equalTo('pending').on('child_added', snap => {
                const order = snap.val();
                
                // CATEGORY MATCHING LOGIC
                // Agar order ki category partner ki category se match kare, TABHI dikhao
                if(order.category === partner.category) {
                    renderLead(snap.key, order);
                }
            });
        }

        function stopListening() {
            db.ref('orders').off();
            document.getElementById('leadsContainer').innerHTML = '<div style="text-align:center; color:#94A3B8;">You are Offline</div>';
        }

        function renderLead(id, order) {
            const div = document.createElement('div');
            div.className = 'lead-card';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; font-weight:700;">
                    <span>${order.service}</span>
                    <span style="color:var(--p);">â‚¹${order.total}</span>
                </div>
                <div style="font-size:0.9rem; color:#64748B; margin:5px 0;">
                    <i class="fa-solid fa-location-dot"></i> ${order.customer.area}
                </div>
                <button onclick="acceptLead('${id}')" style="width:100%; background:var(--p); color:white; border:none; padding:10px; border-radius:8px; margin-top:10px;">Accept Lead</button>
            `;
            document.getElementById('leadsContainer').prepend(div);
        }
        
        // Accept logic same as provided in previous answer
        function acceptLead(id) { /* ... same code as before ... */ }
    </script>
</body>
</html>
